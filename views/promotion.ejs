<!DOCTYPE html>
<html>
<head>
    <title>Promotion</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js" integrity="sha512-JPcRR8yFa8mmCsfrw4TNte1ZvF1e3+1SdGMslZvmrzDYxS69J7J49vkFL8u6u8PlPJK+H3voElBtUCzaXj+6ig==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" type="text/css" href="/styles.css">
    <script src="/search_box.js"></script>
</head>
<body>
<div class="wrapper">
    <%- include('partials/sidebar') %>
    <div class="main_content">
        <div class="header" style="text-transform: uppercase;"><h2>Promotion <i class="fas fa-tags"></i></h2></div>
        <div class="info">
            <div class="table">
                <section class="table__header">
                    <h2>Redemption History</h2>
                    <div class="input-group">
                        <input type="search" id="searchData" name="searchData" placeholder="Search Data...">
                        <i class="fa fa-search" aria-hidden="true"></i>
                    </div>
                </section>
                
                <table class="content-table">
                <thead>
                    <tr>
                        <th>ID <span class="icon-arrow">&#11014;</span></th>
                        <th>Name <span class="icon-arrow">&#11014;</span></th>
                        <th>Description <span class="icon-arrow">&#11014;</span></th>
                        <th>Expiration Date <span class="icon-arrow">&#11014;</span></th>
                        <th>Status <span class="icon-arrow">&#11014;</span></th>
                        <th>Point Cost <span class="icon-arrow">&#11014;</span></th>
                        <th>Edit / Delete</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Use EJS syntax to iterate through promotions and generate table rows -->
                    <% promotions.forEach(promotion => { %>
                        <tr data-promo-id="<%= promotion.promo_id %>">
                            <td data-field="promo_id"><%= promotion.promo_id %></td>
                            <td data-field="promo_name"><%= promotion.promo_name %></td>
                            <td data-field="promo_description"><%= promotion.promo_description %></td>
                            <td data-field="expiration_date"><%= promotion.expiration_date %></td>
                            <td data-field="promo_status">
                                <div class="status <%= promotion.promo_status %>"><%= promotion.promo_status %></div>
                            </td>
                            <td data-field="promo_cost"><%= promotion.promo_cost %></td>
                            <td>
                                <button class="edit-button" onclick="editPromotion('<%= promotion.promo_id %>')">Edit</button>
                                <button class="delete-button" onclick="deletePromotion('<%= promotion.promo_id %>')">Delete</button>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
                </table>
             </div>
             
             <!-- Adding new promotion form -->
             <div class="table">
                <section class="table__header">
                    <h2>Add New Promotion</h2>
                </section>
                <form id="addPromotionForm" action="/addPromotion" method="POST">
                    <table class="content-table">
                        <tbody>
                            <tr>
                                <td><label for="promotionName">Promotion Name:</label></td>
                                <td colspan="3"><input type="text" name="promotionName" required></td>
                            </tr>
                            <tr>
                                <td><label for="promotionDescription">Description:</label></td>
                                <td colspan="3"><input type="text" name="promotionDescription" required></td>
                            </tr>
                            <tr>
                                <td><label for="pointsCost">Points Cost:</label></td>
                                <td>
                                    <input type="text" name="pointsCost" required>
                                </td>
                                <td><label for="expirationDate">Expiration Date:</label></td>
                                <td>
                                    <div class="input-with-calendar">
                                        <i class="fa fa-calendar" aria-hidden="true"></i> <!-- Calendar icon --> <p>&nbsp</p>
                                        <input type="text" name="manualExpirationDate" id="manualExpirationDate" placeholder="MM/DD/YYYY">
                                    </div>
                                    <input type="date" name="expirationDate" id="expirationDate" style="display: none;" required>
                                </td>
                            </tr>
                            <tr>
                                <td><label for="status">Status:</label></td>
                                <td>
                                    <label>
                                        <input type="radio" name="status" value="ACTIVE" checked>
                                        ACTIVE
                                    </label>
                                </td>
                                <td>
                                    <label>
                                        <input type="radio" name="status" value="INACTIVE">
                                        INACTIVE
                                    </label>
                                </td>
                                <td></td>
                            </tr>
                            <tr>
                                <td></td> <!-- Empty cell for spacing -->
                                <td></td>
                                <td></td>
                                <td><button type="button" id="submitPromotion">Add Promotion</button></td>
                            </tr>
                        </tbody>
                    </table>
                </form>
            </div>            
        </div>
    </div>
</div>
<script>
    // Edit and Delete promotion 
    function editPromotion(id) {
        const row = document.querySelector(`tr[data-promo-id="${id}"]`);
        const fields = row.querySelectorAll('td');

        // Make fields editable
        fields.forEach(field => {
            field.contentEditable = true;
        });

        // Change "Edit" button to "Save" button with green color
        const editButton = row.querySelector('.edit-button');
        editButton.textContent = 'Save';
        editButton.style.backgroundColor = '#40a347';
        editButton.style.color = 'white';
        editButton.onclick = () => savePromotion(id);
    }

    function savePromotion(id) {
        const row = document.querySelector(`tr[data-promo-id="${id}"]`);
        const fields = row.querySelectorAll('td');

        // Collect the updated values from the editable fields
        const updatedValues = {};
        fields.forEach(field => {
            updatedValues[field.getAttribute('data-field')] = field.innerText;
            field.contentEditable = false;
        });

        // Send updatedValues to the server via an AJAX request for saving
        fetch(`/promotion/updatePromotion/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedValues),
            })
            .then(response => response.json())
            .then(data => {
                // Handle the response, e.g., show success or error messages
                if (data.success) {
                    // Data was successfully updated on the server
                } else {
                    // Handle the error
                }
            })
            .catch(error => {
                // Handle the fetch error
            });

        // Change "Save" button back to "Edit" button
        const saveButton = row.querySelector('.edit-button');
        saveButton.textContent = 'Edit';
        saveButton.style.backgroundColor = ''; // Remove the green color
        saveButton.onclick = () => editPromotion(id);
    }

    document.getElementById('submitPromotion').addEventListener('click', function() {
    // Get the form data
    const pointsCost = document.querySelector('[name="pointsCost"]').value;
    const expirationDate = document.querySelector('[name="expirationDate"]').value;
    const description = document.querySelector('[name="promotionName"]').value; // Changed to "promotionName"
    const status = document.querySelector('[name="status"]').checked ? 'ACTIVE' : 'INACTIVE';

    // Create a new table row
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>New ID</td>
        <td>${description}</td>
        <td>${description}</td>
        <td>${pointsCost}</td>
        <td>${expirationDate}</td>
        <td class="${status}">${status}</td>
        <td><button class="edit-button" onclick="editPromotion('New ID')">Edit</button></td>
    `;

    // Append the new row to the table
    document.querySelector('.content-table tbody').appendChild(newRow);

    // After adding a new promotion, you should add an event listener for editing that new promotion.
    newRow.querySelector('.edit-button').addEventListener('click', function() {
        editPromotion('New ID'); // You can use a unique ID for the new promotion
    });
});

</script>



</body>
</html>
